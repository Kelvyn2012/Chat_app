{% extends 'chat/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">{{ room.name }}</h4>
            </div>
            <div class="card-body chat-container" id="chat-box">
                {% for message in messages %}
                <div class="message {% if message.user == user %}sent{% else %}received{% endif %}">
                    <div class="message-header">
                        <span class="username">{{ message.user.username }}</span>
                        <span class="timestamp">{{ message.date_added|timesince }} ago</span>
                    </div>
                    <div class="message-content">
                        {{ message.content }}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="card-footer">
                <form id="chat-form" class="d-flex">
                    <input type="text" id="chat-message-input" class="form-control me-2"
                        placeholder="Type your message here..." autocomplete="off">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const roomName = '{{ room.slug }}';
    const username = '{{ user.username }}';

    const chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/'
    );

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const chatBox = document.getElementById('chat-box');

        if (data.type === 'message') {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${data.user === username ? 'sent' : 'received'}`;

            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="username">${data.user}</span>
                    <span class="timestamp">${new Date(data.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="message-content">
                    ${data.message}
                </div>
            `;

            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-form').onsubmit = function (e) {
        e.preventDefault();
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;

        chatSocket.send(JSON.stringify({
            'message': message
        }));

        messageInputDom.value = '';
    };
</script>
{% endblock %}